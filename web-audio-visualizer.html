
<!DOCTYPE html>

<html lang="en">
<head>

    <meta charset="utf-8" />
	<title>Web Audio Visualizer</title>
	<style>
	body {
         background: #eeeeee;
         font-family: tahoma, verdana, sans serif;
      }

      canvas {
        margin-left:10px;
        margin-top:10px;
        box-shadow: 4px 4px 8px rgba(0,0,0,0.5);
        background: black;
    }
      
      #controls{
      	margin-left:10px;
        margin-top:10px;
      }
	</style>
	<script>
    // make stars
    // make skeleton heads
    // program heads
	// An IIFE ("Iffy") - see the notes in mycourses
	(function(){
		"use strict";
		
		var NUM_SAMPLES = 256;
		var SOUND_1 = 'media/PaperPlanes.mp3';
		var SOUND_2 = 'media/SpookyScarySkeletons.mp3';
		var SOUND_3 = 'media/HighScore.mp3';
		var currentSound = SOUND_1;
		var starCount=200;
		var audioElement;
		var analyserNode;
		var canvas,ctx;
        var invert = false, tintRed=false, noise=false, lines=false;
        var starsx = [];
        var starsy = [];
        var gravCircs = [];
        var prevData = [256];
		var skullHead, skullJaw, skullHelmet;
		function init(){
			// set up canvas stuff
			canvas = document.querySelector('canvas');
			ctx = canvas.getContext("2d");
          
         document.querySelector("#invert").onchange=function(e){
              if(this.checked){
                  invert=true;
              }
              else{
                  invert=false;
              }
          };         document.querySelector("#noise").onchange=function(e){
              if(this.checked){
                  noise=true;
              }
              else{
                  noise=false;
              }
          }; document.querySelector("#lines").onchange=function(e){
              if(this.checked){
                  lines=true;
              }
              else{
                  lines=false;
              }
          };
           document.querySelector("#tint").onchange=function(e){
              if(this.checked){
                  tintRed=true;
              }
              else{
                  tintRed=false;
              }
          };
            initializeStars();
          // get reference to <audio> element on page
			audioElement = document.querySelector('audio');
			
			// call our helper function and get an analyser node
			analyserNode = createWebAudioContextWithAnalyserNode(audioElement);
			
			// get sound track <select> and Full Screen button working
			setupUI();
            // makeStars();
			drawCircle(60,60);

			// skull things
            skullHelmet= new Image();
            skullHelmet.src="media/skulls-Helmet.png";
            
            skullHead = new Image();
            skullHead.src="media/skulls-Top.png"
            
            skullJaw=new Image();
            skullJaw.src="media/skulls-Bottom.png";
			
			// load and play default sound into audio element
			playStream(audioElement,SOUND_1);
			// start animation loop
			update();
		}
		
		function initializeStars(){
            
            for(var i=0; i<starCount; i++){
                 
                var xPos=Math.random()*canvas.width;
                var yPos = Math.random()*canvas.height;
                
               starsx[i]=xPos;
               starsy[i]=yPos;
               // drawCircle(xPos, yPos);
            }
        }
          function makeStars(){
            
            for(var i=0; i<starCount; i++){
                drawCircle(starsx[i], starsy[i]);
            }
        }

        function zeroGravity(){
        	for(var i = 0; i < gravCircs.length; i++){
        		
        	}
        }
        
         function drawCircle(xPos, yPos,alpha){
                alpha=(alpha/100)-1;
            
                ctx.beginPath();
                ctx.fillStyle='rgba(255,255,255,'+alpha+')';
                ctx.arc(xPos,yPos,2, 0,2*Math.PI,false);
                ctx.fill();
                
         }
		function createWebAudioContextWithAnalyserNode(audioElement) {
			var audioCtx, analyserNode, sourceNode;

			// create new AudioContext
			audioCtx = new (window.AudioContext || window.webkitAudioContext);
			
			// create an analyser node
			analyserNode = audioCtx.createAnalyser();
			
			// fft stands for Fast Fourier Transform
			analyserNode.fftSize = NUM_SAMPLES;
			
			// this is where we hook up the <audio> element to the analyserNode
			sourceNode = audioCtx.createMediaElementSource(audioElement); 
			sourceNode.connect(analyserNode);
			
			// here we connect to the destination i.e. speakers
			analyserNode.connect(audioCtx.destination);
			return analyserNode;
		}
		
		function setupUI(){
			document.querySelector("#trackSelect").onchange = function(e){
				playStream(audioElement,e.target.value);
				currentSound = e.target.value;
			};
			
			document.querySelector("#fsButton").onclick = function(){
				requestFullscreen(canvas);
			};
            document.querySelector("#slider1").onchange = function(e){
			 	console.log("value=" + e.target.value);
			 	 document.querySelector("#sliderResults").innerHTML = e.target.value;
                 
			 };
		}
		
		function playStream(audioElement,path){
			audioElement.src = path;
			audioElement.play();
			audioElement.volume = 0.2;
			document.querySelector('#status').innerHTML = "Now playing: " + path;
		}
		
		function update() { 
			// this schedules a call to the update() method in 1/60 seconds
			requestAnimationFrame(update);
			
			// create a new array of 8-bit integers (0-255)
			var data = new Uint8Array(NUM_SAMPLES/2); 
			
			// populate the array with the frequency data
			// notice these arrays can be passed "by reference" 
			analyserNode.getByteFrequencyData(data);
		
            var jawY = 160;
			
			// DRAW!
			ctx.clearRect(0,0,800,600); 
			//make stars
              		for(var i=0; i<starCount; i++){
               			 drawCircle(starsx[i], starsy[i], data[3]);
            		}
			var barWidth = 4;
			var barSpacing = 1;
			var barHeight = 100;
			var topSpacing = 50;
           
			if(currentSound==SOUND_2){
                //draw first skull
                ctx.save();
                ctx.globalAlpha=.5;                 
                ctx.drawImage(skullJaw, 45, data[3], 250,270);
                ctx.drawImage(skullHead, 50, 60, 250,270);
                
                ctx.drawImage(skullHelmet, 50,60,250,270);
                
                //draw second skull
                ctx.drawImage(skullJaw, 345, data[3], 250,270);
                ctx.drawImage(skullHead, 350, 60, 250,270);
                
                ctx.drawImage(skullHelmet, 350,60,250,270);
                ctx.restore();
            }

			// loop through the data and draw!
			ctx.fillStyle = 'rgba(0,230,255,0.6)'; 
			ctx.strokeStyle = 'rgba(0,230,255,0.6)'; 
			ctx.lineWidth = barWidth;
			ctx.lineCap = 'round';

			for(var i=0; i<data.length; i++) { 
          
				// the higher the amplitude of the sample (bin) the taller the bar
				// remember we have to draw our bars left-to-right and top-down
				//ctx.fillRect(i * (barWidth + barSpacing),topSpacing + 256-data[i],barWidth,barHeight); 
                //ctx.fillRect(640-i*(barWidth+barSpacing), topSpacing+256-data[i]-20,barWidth, barHeight);

                ctx.beginPath();
                ctx.moveTo(i * (barWidth + barSpacing), topSpacing + 256-data[i]);
                ctx.lineTo(i * (barWidth + barSpacing), topSpacing + 256-data[i] + barHeight);
                ctx.stroke();

                if((data[i] - prevData[i]) >= 20){
                	ctx.save();
		        	ctx.fillStyle = 'red';
		        	ctx.beginPath();
		        	ctx.arc(i * (barWidth + barSpacing), topSpacing + 256-data[i], barWidth, 0, Math.PI*2, false);
		        	ctx.fill();
		        	ctx.closePath();
		        	ctx.restore();
                }

                zeroGravity();
                var percent = data[i]/255;
                prevData[i] = data[i];
            }
			
              
          // manipulatePixels();
			 
		} //End of update
        
		// HELPER
		function makeColor(red, green, blue, alpha){
   			var color='rgba('+red+','+green+','+blue+', '+alpha+')';
   			return color;
		}
		
		 // FULL SCREEN MODE
		function requestFullscreen(element) {
			if (element.requestFullscreen) {
			  element.requestFullscreen();
			} else if (element.mozRequestFullscreen) {
			  element.mozRequestFullscreen();
			} else if (element.mozRequestFullScreen) { // camel-cased 'S' was changed to 's' in spec
			  element.mozRequestFullScreen();
			} else if (element.webkitRequestFullscreen) {
			  element.webkitRequestFullscreen();
			}
			// .. and do nothing if the method is not supported
		};
		
		
		window.addEventListener("load",init);
	}());
		
	</script>
</head>
<body>
	<canvas id="canvas" width="640" height="400"></canvas>
	<div id="controls">
		<audio controls loop></audio>
		<label>Track: 
			<select id="trackSelect" >
				<option value="media/PaperPlanes.mp3" selected>Paper Planes</option>
				<option value="media/SpookyScarySkeletons.mp3">Spooky Scary Skeletons</option>
				<option value="media/HighScore.mp3">High Score</option>
			</select>
		</label>
		<button id="fsButton">Go Full Screen</button><br>
        <label for="slider1"> Max Radius Slider</label>
        <input id="slider1" type="range" min="10" max="200" step="20" value="50">
        <span id="sliderResults">???</span> <br>
        <input type="checkbox" id="invert" name="noise" value="false"> Invert <br>
        <input type="checkbox" id= "noise" name="noise" value="noise"> Noise <br>
        <input type="checkbox" id="tint" name="noise" value="noise"> Tint Red <br>
        <input type="checkbox" id="lines" name="lines" value="noise"> Lines <br>
		<p id="status">???</p>
	</div>
</body>
</html>
